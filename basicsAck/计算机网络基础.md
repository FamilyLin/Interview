# 计算机网络基础

## 1、体系结构

### 1.1、分层

#### 1.1.1、OSI模型

1. 应用层
2. 表示层
3. 会话层
4. 传输层
5. 网络层
6. 链路层
7. 物理层

#### 1.1.2、TCP/IP模型

1. 应用层
2. 传输层
3. 网络层
4. 物理链路层

#### 1.1.3、各层协议

1. 应用层：HTTP、FTP、SMTP
2. 传输层：TCP、UDP
3. 网络层：IP、ARP
   - **ARP协议**：每个主机都有自己的ARP缓存区，包含ARP列表，表示IP地址和对应的MAC地址；
     - 源主机要发送数据时，会检查ARP列表中是否有对应的IP地址和MAC地址，如果有就直接发送，没有的话，向本网段所有主机发送ARP数据包，包括自己的IP地址和MAC地址还有目的主机的IP地址
     - 本网段的主机接收到，会进行匹配，匹配成功将自己的MAC地址写入ARP响应包中，发送回源主机
     - 匹配失败，ARP查询失败
4. Ping工作过程
   - Ping命令会构建一个固定格式的ICMP数据包，包括：源主机IP、MAC，目的主机IP，
   - 利用ARP协议发送
   - 目的主机收到后，拆包，匹配，添加目的主机MAC地址，构建ICMP应答包，发送给源主机



### 1.2、链路层协议

#### 1.2.1、链路层协议基础

- 封装成帧
- 透明传输
- 差错检测

1. 封装成帧

   internet传送的数据以**IP数据报**为传送单位，网络层的数据报传送到数据链路层就成为帧的数据部分，在数据部分的前后加上首部和尾部，构成一个完整的帧

2. 透明传输

   使用**字节填充**方法来避免帧的定界错误，即在帧的结束控制符前面插入转义字符“ESC”

3. 差错检测

   **循环冗余检验CRC**

#### 1.2.2、点对点协议PPP

PPP(Point-to-Point Protocol)是目前使用最广泛的数据链路层协议，指用户计算机和ISP进行通信是所使用的数据链路层协议

#### 1.2.3、局域网的数据链路层

局域网按照拓扑结构可分为：总线结构、环形结构、星型结构、网状结构、树形结构、混合型结构

#### 1.2.4、以太网

以太网：局域网的代名词

计算机的IP地址在计算机的存储器中，硬件地址在适配器的ROM中。

#### 1.2.5、CSMA/CD协议

1. 总线上只要有一台计算机在发送数据，总线的传输资源就被占用。同一时间只能允许一台计算机发送信息，否则会有干扰
2. 以太网采用的协调方法是CSMA/CD协议：载波监听多点接入/碰撞检测
   - **载波监听**：发送前先监听，如果总线上没有其他站发送数据，再发送；如果有，则等待
   - **多点接入**：许多计算机以多点接入的方式连接在一根总线上
   - **碰撞检测**：边发送边监听，适配器边发送数据边检测信道上的信号电压的变化情况，以便判断自己在发送数据时，其他站是否也在发送数据，一旦发送碰撞，适配器就要立刻停止发送
3. 使用CSMA/CD协议时，一个站不能同时进行发送与接收，因此不能进行全双工通信，只能进行**半双工通信**

#### 1.2.6、MAC地址

局域网中，**硬件地址**又称为**物理地址**，或**MAC地址**：共48位，前24位由注册管理机构分配给厂家，后24位由厂家指派。

适配器有过滤功能，适配器从网络上每收到一个MAC帧就先用硬件检查MAC帧中的目的地址，如果是发往本站的帧则收下，否则丢弃。发往本站的帧包括三种：

- 单播帧：收到的帧的MAC地址与本站的硬件地址相同
- 广播帧：发送给本局域网上的所有站点的帧
- 多播帧：发送给本局域网上一部分站点的帧

MAC帧的格式：目的地址、源地址、类型（上一层使用的协议）、数据字段、FCS序列

#### 1.2.7、局域网的扩展

1. 集线器：在物理层扩展局域网

   - 优点：使原来属于不同碰撞域的局域网上的计算机能够进行跨碰撞域的通信；扩大了局域网的覆盖范围
   - 缺点：碰撞域增大了，但总的吞吐量并未提高；如果不同的碰撞域使用不同的数据率，那么就不能用集线器将它们互联起来

2. 网桥：在数据链路层扩展局域网

   网桥工作在数据链路层，根据MAC帧的目的地址对收到的帧进行转发，具有过滤功能

   - 优点：过滤通信量；扩大物理范围；可连接不同的物理层、不同的MAC子网和不同速率的局域网
- 缺点：存储转发增加了时延；只适用于用户数不太多和通信量不太大的局域网，否则有时还会因传播过多的广播信息而产生网络拥塞，即广播风暴。
  

3. 交换机

   多接口网桥，工作在数据链路层，可以方便的实现虚拟局域网VLAN

4. 无线局域网WLAN

   

### 1.3、传输层协议

#### 1.3.1、概述

传输层为应用进程之间提供端到端的逻辑通信；网络层为主机之间提供逻辑通信

传输层主要有两种不同的传输协议：

1. UDP：用户数据报协议：在传送数据之前不需要先建立连接，对方的传输层在收到UDP报文后，不需要给出任何确认，虽然UDP不提供可靠交付，但在某些情况下UDP是一种最有效地工作方式
2. TCP：传输控制协议：提供面向连接的服务，不提供广播或多播服务，由于TCP要提供可靠的，面向连接的传输服务，因此不可避免的会增加开销

#### 1.3.2、端口号

在传输层使用协议端口，简称端口，标记应用进程，不同的进程有不同的端口号，用16位的端口进行标志

1. 服务端使用的端口号：熟知端口：0~1023

   ​                                      登记端口号：1024~49151

2. 客户端使用的端口号：49152~65535：留给客户进程选择暂时使用

#### 1.3.3、UDP

- UDP首部仅占8字节，无拥塞控制
- UDP面向报文、不可靠
- 对应的协议：
  - DNS：53
  - TFTP：
- 怎样实现UDP可靠传输：UDP数据包+序列号



#### 1.3.4、TCP

- TCP连接是点对点的，面向字节流，但是传送的数据单元是报文段，可以提高可靠交付的服务，保证数据无差错、不丢失、不重复、按序到达，**提供全双工通信**
- TCP根据对方给出的窗口和当前网络的拥塞决定一个报文段应包含多少个字节。TCP连接的端点为套接字（Socket==IP地址：端口号）
- 对应的协议：
  1. FTP：21、20
  2. Telnet：23
  3. SMTP：25
  4. POP3：110
  5. HTTP：80
  6. HTTPs：443
- 可靠性维护机制：
  1. 超时重传
  2. 快速重传
  3. 校验机制：接收到的报文段有错，丢掉，等待超时重传
  4. 拥塞控制
- 拥塞控制原理
  1. 慢开始
  2. 拥塞避免
  3. 快重传
  4. 快恢复
- 滑动窗口协议与停止等待协议
  1. 滑动窗口：只有接收窗口向后滑动，发送窗口才能滑动
  2. 停止等待：接收方，无法接收，反馈给发送方，等待

#### 1.3.5、TCP的连接控制

传输连接分为三个阶段：

- 建立连接
- 数据传输
- 关闭连接

##### 1.3.5.1、TCP的三次握手

1. 服务器一直处于监听状态；

   客户端-->服务器：同步位：SYN=1

   ​                              初始序号：seq=x

2. 服务器收到请求报文段，同一建立连接，发送确认：        

   ​                 同步位：SYN=1

   ​             确认字符：ACK=1

   ​                确认号：ack=x+1

   ​             初始序号：seq=y

3. 客户端收到确认，并向服务器发送确认信息：

   ​             确认字符：ACK=1

   ​                确认号：ack = y +1

   ​         自己的序号：seq= x+1

##### 1.3.5.2、四次挥手

1. 客户端向服务端发送关闭报文段，进入终止等待状态1

2. 服务器收到关闭报文段，发出确认，进入关闭等待状态；

   客户端收到服务器的确认，进入终止等待状态2

3. 服务器发送完数据，向客户端发送关闭确认报文段，进入最后确认状态

4. 客户端收到确认关闭报文段，发出确认，并进入时间等待状态，等待最长报文段寿命*2的时间后关闭；服务器收到确认后即关闭

**为什么要等待2MSL：**防止最后一个ACK包没收到，服务器超时重传，无法收到；防止新连接中混淆前一次滞留的某些数据‘

### 1.4、应用层协议

#### 1.4.1、域名系统

使用DNS将域名解析为IP

#### 1.4.2、域名

任何一个连接在Internet中的主机或路由器，都有一个惟一的层次结构名字：域名

#### 1.4.3、域名服务器

1. 根域名服务器
2. 顶级域名服务器
3. 权限域名服务器
4. 本地域名服务器

- **DNS查询算法**
- 主机向本地域名服务器的查询采用递归查询，如果主机询问的本地域名服务器不知道被查询域名的IP地址，则本地域名服务器向根域名服务器发出请求报文
- 本地域名服务器向根服务器的查询采用迭代查询
  - 首先向根域名服务器进行查询，根域名服务器吧顶级域名服务器的IP地址告诉本地域名服务器
  - 向顶级域名服务器发起查询，获得权限域服务器IP地址
  - 再向权限域名服务器发送请求，获取IP；或者查询失败
- DNS负载均衡：一个域名配置多个IP地址，根据每台机器的负载及距离用户的地理位置返回IP

#### 1.4.4、文件传送协议（FTP）



#### 1.4.5、网络文件系统（NFS）

#### 1.4.6、简单文件传输协议（TFTP）

使用UDP，速度快

#### 1.4.7、远程终端协议（TELNET）

使用TCP连接到远程计算机

#### 1.4.8、同一资源定位符（URL）

<协议>://<主机>:<端口>/<路径>

http://127.0.0.1:8080/desktop/java.......

#### 1.4.9、超文本传送协议HTTP

- 定义了浏览器怎样想万维网服务器请求万维网文档，以及服务器怎样把文档传送给浏览器。
- 面向事务
- **输入网址后发生的事件**

1. 浏览器向DNS请求解析域名；
2. 域名系统DNS解析出服务器的IP地址
3. 传输层建立TCP连接
4. 网络层查找MAC地址
5. 数据传输
6. TCP连接断开



#### 1.4.10、代理服务器（万维网高速缓存）



#### 1.4.11、电子邮件

##### 1.4.11.1、电子邮件系统主要组成

1. 用户代理
2. 邮件服务器
3. 邮件发送协议（SMTP)与邮件读取协议（POP）

##### 1.4.11.2、简单邮件传送协议（SMTP)

##### 1.4.11.3、邮件读取协议（POP和IMAP)

##### 1.4.11.4、MIME

MIME并没有替代SMTP，而是增加了邮件的主体结构

#### 1.4.12、动态主机配置协议（DHCP)

- 使用UDP协议工作
  1. 需要IP的主机先向DHCP服务器广播发送报文；此时已知本地MAC，本地端口67，服务器端口68；未知本地IP（0.0.0.0）、服务器IP（255.255.255.255）、服务器MAC地址；
  2. DHCP服务器收到后，分配IP地址给主机（通过点播方式）
- 三种机制分配IP地址
  - 自动分配：分配永久IP
  - 动态分配： 分配有时间限制的IP
  - 手工分配：管理员指定

#### 1.4.13、TTL

- 生存时间，经由一个路由器后减1，最终为0，丢弃，避免两个路由器之间形成环。
- traceroute：利用ICMP协议定位计算机和目标计算机之间的所有路由，TTL值反映数据包经过的路由器或网关数量
- Ping中的TTL不是必须的



### 1.5、网络层

1. 网络层：IP、ARP
   - ARP协议：每个主机都有自己的ARP缓存区，包含ARP列表，表示IP地址和对应的MAC地址；
     - 源主机要发送数据时，会检查ARP列表中是否有对应的IP地址和MAC地址，如果有就直接发送，没有的话，向本网段所有主机发送ARP数据包，包括自己的IP地址和MAC地址还有目的主机的IP地址
     - 本网段的主机接收到，会进行匹配，匹配成功将自己的MAC地址写入ARP响应包中，发送回源主机
     - 匹配失败，ARP查询失败
2. Ping工作过程
   - Ping命令会构建一个固定格式的ICMP数据包，包括：源主机IP、MAC，目的主机IP，
   - 利用ARP协议发送
   - 目的主机收到后，拆包，匹配，添加目的主机MAC地址，构建ICMP应答包，发送给源主机
3. IP头：20字节，最长60字节
   - 版本
   - 标识
   - 生存期
   - 源地址
   - 目标地址



### 1.6电路交换和分组交换

#### 1.6.1 电路交换

通信双方在通信之前建立一条被双方独占的物理通路：

**优点：**

1. 数据直达，时延小
2. 物理通路一旦建立，随时通信，实时性强
3. 按发送顺序进行数据传输，无失序问题
4. 适用于模拟信号、数字信号传输
5. 电路交换设备较为简单

**缺点**：

1. 平均连接时间长
2. 信道利用低，无信号传输，空闲
3. 不同规格的终端很难进行通信



#### 1.6.2分组交换

采用存储转发传输方式，将一个长报文分割为若干个较短分组，然后逐个发送（携带源、目的地址、编号信息）

**优点：**

1. 后一组的存储与前一组的转发并行，减少了报文传输时间
2. 简化了存储管理
3. 减少了出错几率和重发数据量
4. 可采用优先级策略，及时发送紧急数据

**缺点:**

1. 存在存储转发时延
2. 每个分组都要携带源、目的、编号信息



**总结：**传输数据量大，传送时间大于呼叫时间，利用电路交换

端到端的通路有很多链路组成，分组交换合适。

利用率上，分组交换优于电路交换





### 1.7HTTP请求的基本格式与状态码

#### 1.7.1基本格式

1. 请求行
   1. 请求的方法：get/post
   2. 请求URL
   3. 版本
2. 请求头
   1. 客户端Cookie，用户代理
3. 空白行
4. 请求实体

- 响应行：状态码、版本
- 响应头：服务器的Cookie和Server信息
- 空白行
- 响应体

#### 1.7.2状态码

1. 200：OK
2. 204：OK，但是响应报文中不含响应体，表示浏览器不更新
3. 301：永久性重定向
4. 302：临时性重定向
5. 400：请求失败，请求报文中存在语法错误
6. 401：用户名密码验证
7. 403：请求被服务器拒绝，无权访问
8. 404：无法找到请求的资源
9. 500：服务器执行请求时出错
10. 503：服务器超负载或停机维护



#### 1.7.3HTTP长连接和短连接

本质上是TCP的长连接和短连接

1. Http1.0：
   - 短连接
2. http1.1：
   - 长连接
   - 管道机制：客户端可同时发送多个请求
3. http2：
   - 多路复用/多工：可同时发送、响应多个请求；避免了队头堵塞
   - 全部使用二进制流，在应用层和传输层之间多一个二进制分帧层
   - 首部压缩：避免每次发送都附上所有信息
   - 服务端推送
4. 

#### 1.7.4Http和https

1. 区别：
   - http使用80端口、无状态、明文传输
   - https使用443端口、SSL加密
2. https传输过程
   1. 服务器将网站的证书（包含公钥）发送个客户端
   2. 客户端建立会话密钥，并用公钥加密，发送给服务器
   3. 服务器用自己的私钥解密，得到会话密钥
   4. 通信
3. https缺点
   - 增加了加载时间
   - 开销大
   - ssl证书费用高
   - SSL证书需要绑定IP
4. SSL协议：网络层和应用层之间
5. TSL协议：传输层
6. https速度的优化：
   - HSTS重定向技术，省去了301跳转
   - 握手优化：握手过程中开始发送请求数据，握手成功发送响应
   - SessionID
   - OSCP Stapling：握手过程中，服务器发送CA签名的OSCP响应，避免客户端再去查询验证
   - 完全前向加密PFS：使用更复杂的密钥算法



#### 1.7.5HTTP认证

#### 1.7.6 Http Server

1. 单进程处理请求
2. 多进程处理请求
3. 单进程 Select处理请求，遍历
4. 单进程并发 epoll处理请求，非遍历

#### 1.7.7JWT（JSON WEB Token）

1. 服务器认证后，生成JSON对象，发送给用户
2. 结构
   - 头部
   - 负载
   - 签名
3. JWT默认不加密；一旦签发，到期之前一直有效；为减少盗用，要使用https协议传输



### 1.8网络安全

1. 攻击
   1. **SYN攻击**：客户端伪造大量不存在的IP，不断发送SYN，服务器收到后回应  等待  占用资源；可以缩短回应超时时间；过滤网关防护
   2. **ARP攻击**：缓存表基于后到优先原则，IP与MAC的映射关系可能会被覆盖；中间人利用伪造的ARP数据包，可以截获通信











